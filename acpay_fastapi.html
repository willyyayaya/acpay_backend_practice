<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <title>PRIME Mode (FastAPI Version)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { margin: 20px 0; }
        .jumbotron { text-align: center; }
        .container { max-width: 750px; }
        form { padding: 40px; box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08); border-radius: 10px; }
    </style>
</head>
<body>
<div class="container">
    <form id="order-form" class="bg-light p-4 rounded">
        <h3 class="text-center">創建訂單</h3>
        <div class="mb-3">
            <label for="email" class="form-label">Email 地址</label>
            <input type="email" class="form-control" id="email" required placeholder="請輸入 Email">
        </div>
        <button type="submit" class="btn btn-primary w-100">提交訂單</button>
    </form>

    <div id="result" class="mt-4"></div>

    <h3 class="mt-4">交易記錄管理</h3>
    <button class="btn btn-info mb-3" onclick="fetchPayments()">取得所有交易記錄</button>

    <div class="mb-3">
        <label for="delete-id" class="form-label">刪除交易記錄 ID</label>
        <input type="number" class="form-control" id="delete-id" placeholder="輸入交易記錄 ID">
    </div>
    <button class="btn btn-danger w-100 mb-3" onclick="deletePayment()">刪除交易記錄</button>

    <div class="mb-3">
        <label for="update-id" class="form-label">更新交易記錄 ID</label>
        <input type="number" class="form-control" id="update-id" placeholder="輸入交易記錄 ID">
    </div>
    <div class="mb-3">
        <label for="update-email" class="form-label">新 Email</label>
        <input type="email" class="form-control" id="update-email" placeholder="輸入新 Email">
    </div>
    <button class="btn btn-warning w-100" onclick="updatePayment()">更新交易記錄</button>

    <table class="table table-striped mt-4" id="payments-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>PRIME</th>
                <th>時間</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const API_BASE_URL = "http://127.0.0.1:8000";

    // 提交訂單
    document.getElementById("order-form").addEventListener("submit", function (event) {
        event.preventDefault();
        const email = document.getElementById("email").value;
        
        fetch(`${API_BASE_URL}/order`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(res => res.json())
        .then(data => {
            if (data.order_id) {
                document.getElementById("result").innerHTML = `
                    <div class="alert alert-success">
                        <h4>訂單已創建</h4>
                        <p><strong>訂單ID:</strong> ${data.order_id}</p>
                        <p><strong>Prime:</strong> ${data.prime}</p>
                    </div>`;
                alert('請複製 Prime 並前往支付！');
            } else {
                alert('創建訂單失敗！');
            }
        })
        .catch(err => console.error('發生錯誤:', err));
    });

    // 取得所有交易記錄
    function fetchPayments() {
        fetch(`${API_BASE_URL}/payments`)
            .then(res => res.json())
            .then(data => {
                let tableBody = document.querySelector("#payments-table tbody");
                tableBody.innerHTML = "";
                data.forEach(payment => {
                    tableBody.innerHTML += `
                        <tr>
                            <td>${payment.id}</td>
                            <td>${payment.email}</td>
                            <td>${payment.prime}</td>
                            <td>${new Date(payment.created_at).toLocaleString()}</td>
                        </tr>`;
                });
            })
            .catch(err => console.error('查詢失敗:', err));
    }

    // 刪除交易記錄
    function deletePayment() {
        const id = document.getElementById("delete-id").value;
        fetch(`${API_BASE_URL}/payments/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            fetchPayments();
        })
        .catch(err => console.error('刪除失敗:', err));
    }

    // 更新交易記錄
    function updatePayment() {
        const id = document.getElementById("update-id").value;
        const email = document.getElementById("update-email").value;

        fetch(`${API_BASE_URL}/payments/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            fetchPayments();
        })
        .catch(err => console.error('更新失敗:', err));
    }
</script>
</body>
</html>
